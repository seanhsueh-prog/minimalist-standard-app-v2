<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minimalist V13.5 - Mobile UX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* [V13.5 æ ¸å¿ƒæ¨£å¼] */
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            -webkit-font-smoothing: antialiased; 
            background-color: #f3f4f6; /* æ¡Œæ©ŸèƒŒæ™¯è‰² */
            color: #111; 
            margin: 0;
        }
        
        /* V13.5 FIX: æ‰‹æ©Ÿç‰ˆé¢æ¨¡æ“¬å®¹å™¨ */
        .app-container {
            max-width: 480px; /* é–å®šæ‰‹æ©Ÿå¯¬åº¦ */
            margin: 0 auto;   /* ç½®ä¸­ */
            min-height: 100dvh;
            background-color: #ffffff; /* App æœ¬é«”èƒŒæ™¯ */
            box-shadow: 0 0 40px rgba(0,0,0,0.1); /* æ‡¸æµ®æ„Ÿé™°å½± */
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* V13.5 FIX: å¼·åˆ¶ 9:16 é»ƒé‡‘æ¯”ä¾‹ */
        .ghost-canvas-container {
            position: relative;
            width: 100%;
            aspect-ratio: 9/16; /* é—œéµ: é–å®šé•·å¯¬æ¯” */
            max-height: 75vh;   /* é¿å…éé•· */
            background-color: #ffffff;
            overflow: hidden;
            /* ç§»é™¤èˆŠç‰ˆå¼·åˆ¶ height: 60vhï¼Œæ”¹ç”¨ aspect-ratio è‡ªé©æ‡‰ */
        }

        .ghost-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; 
            object-position: bottom center; /* è²¼åº•å°é½Š */
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        @keyframes pulse-white {
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 0 6px rgba(255, 255, 255, 0); }
            100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        .marker-pulse {
            animation: pulse-white 2s infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. CONFIGURATION ---
        const DEFAULT_ASSETS = {
            inner: './inner.png',
            outer: './outer.png',
            bottom: './bottom.png',
            shoes: './shoes.png'
        };

        const MARKER_POS = {
            inner: { x: 50, y: 35 },
            outer: { x: 50, y: 45 },
            bottom: { x: 50, y: 65 },
            shoes: { x: 50, y: 92 }
        };

        const getAssetUrl = (item) => {
            if (!item) return null;
            if (item.image) return item.image; 
            if (item.slot === 'inner') return DEFAULT_ASSETS.inner;
            if (item.slot === 'outer' || item.slot === 'coat') return DEFAULT_ASSETS.outer;
            if (item.slot === 'bottom') return DEFAULT_ASSETS.bottom;
            if (item.slot === 'shoes') return DEFAULT_ASSETS.shoes;
            return null;
        };

        const getSlotDefaultPos = (slotId) => {
            if (slotId === 'inner') return MARKER_POS.inner;
            if (slotId === 'outer' || slotId === 'coat') return MARKER_POS.outer;
            if (slotId === 'bottom') return MARKER_POS.bottom;
            if (slotId === 'shoes') return MARKER_POS.shoes;
            return null;
        };

        // --- 2. DATA STRUCTURES ---
        const SLOTS = [
            { id: 'coat', label: 'å¤§è¡£' },
            { id: 'outer', label: 'å¤–å¥—' },
            { id: 'inner', label: 'å…§æ­' },
            { id: 'bottom', label: 'ä¸‹èº«' },
            { id: 'shoes', label: 'é‹æ¬¾' },
            { id: 'bag', label: 'åŒ…æ¬¾' },
            { id: 'jewelry', label: 'é…é£¾' }
        ];

        const INVENTORY_TABS = [
            { id: 'outer', label: 'å¤–å¥—', slots: ['outer', 'coat'] },
            { id: 'inner', label: 'å…§æ­', slots: ['inner'] },
            { id: 'bottom', label: 'ä¸‹èº«', slots: ['bottom'] },
            { id: 'shoes', label: 'é‹æ¬¾', slots: ['shoes'] }
        ];

        const CATEGORIES = {
            coat: ['å¤§è¡£', 'é¢¨è¡£'],
            outer: ['è¥¿è£å¤–å¥—', 'çš®è¡£', 'çŸ­ç‰ˆå¤–å¥—', 'ç¾½çµ¨å¤–å¥—', 'é‹å‹•å¤–å¥—'],
            inner: ['Tæ¤', 'é‡ç¹”è¡«', 'è¥¯è¡«', 'è¡›è¡£'],
            bottom: ['è¥¿è£è¤²', 'ä¸¹å¯§è¤²', 'ä¼‘é–’è¤²', 'é‹å‹•è¤²', 'çŸ­è¤²'],
            shoes: ['é‹å‹•é‹', 'çš®é‹', 'é´å­', 'æ¨‚ç¦é‹'],
            bag: ['å…¬äº‹åŒ…', 'æ‰˜ç‰¹åŒ…', 'æ‰‹æ‹¿åŒ…', 'å¾ŒèƒŒåŒ…'],
            jewelry: ['æ‰‹ç’°', 'æ‰‹éŒ¶', 'æˆ’æŒ‡', 'çœ¼é¡', 'ç„¡é…é£¾']
        };

        const ALL_COLORS = [
            { id: 'black', hex: '#1A1A1A', name: 'é»‘' },
            { id: 'white', hex: '#FFFFFF', name: 'ç™½', border: true },
            { id: 'gray', hex: '#808080', name: 'ç°' },
            { id: 'navy', hex: '#1E3A8A', name: 'æ·±è—' },
            { id: 'earth', hex: '#C3B091', name: 'å¤§åœ°' },
            { id: 'burgundy', hex: '#991b1b', name: 'é…’ç´…' },
            { id: 'mustard', hex: '#d97706', name: 'èŠ¥é»ƒ' },
            { id: 'olive', hex: '#4d7c0f', name: 'è»ç¶ ' },
            { id: 'royalblue', hex: '#2563eb', name: 'å¯¶è—' }
        ];

        // V13.5: Hardcoded Demo Data
        const DEFAULT_WARDROBE = [
            { id: 1, slot: 'outer', category: 'çš®è¡£', color: 'black' },
            { id: 2, slot: 'inner', category: 'Tæ¤', color: 'white' },
            { id: 3, slot: 'bottom', category: 'è¥¿è£è¤²', color: 'black' },
            { id: 4, slot: 'shoes', category: 'é‹å‹•é‹', color: 'white' },
            // V13.5 Demo Data
            { id: 991, slot: 'outer', category: 'çš®è¡£', category_detail: 'æ¼”ç¤ºçš®è¡£', color: 'black', image: './outer_demo.png' },
            { id: 992, slot: 'bottom', category: 'è¥¿è£è¤²', category_detail: 'æ¼”ç¤ºè¥¿è¤²', color: 'black', image: './bottom_demo.png' }
        ];
        
        const DEFAULT_OUTFIT = { coat: null, outer: null, inner: null, bottom: null, shoes: null, bag: null, jewelry: null };
        const WARDROBE_KEY = 'minimalist_v13_5_data'; 

        // --- 3. UI ICONS ---
        const Icon = ({ name, className }) => {
            const icons = {
                plus: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
                trash: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
                camera: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
                star: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
                check: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
                dice: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/></svg>,
                download: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
                x: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            };
            return icons[name] ? React.cloneElement(icons[name], { className }) : null;
        };

        // --- 4. COMPONENTS ---

        const AddItemModal = ({ isOpen, onClose, onAdd }) => {
            const [data, setData] = useState({ 
                slot: 'outer', 
                category: CATEGORIES['outer'][0], 
                color: 'black', 
                image: null 
            });
            const fileInputRef = useRef(null);
            
            const handleSlotChange = (newSlot) => {
                const defaultCat = CATEGORIES[newSlot] ? CATEGORIES[newSlot][0] : '';
                setData(prev => ({ ...prev, slot: newSlot, category: defaultCat }));
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    setData(prev => ({ ...prev, image: url }));
                }
            };

            if(!isOpen) return null;

            // V13.5: Handle Save accepts 'equip' boolean
            const handleSave = (shouldEquip) => {
                const finalCategory = data.category || CATEGORIES[data.slot][0];
                const finalColor = data.color || 'black'; 
                const newItem = { 
                    ...data, 
                    category: finalCategory, 
                    color: finalColor,
                    id: Date.now() 
                };
                
                onAdd(newItem, shouldEquip); 
                
                const msg = shouldEquip ? `âœ… å·²å…¥åº«ä¸¦ç©¿ä¸Š` : `âœ… å·²åŠ å…¥è¡£æ«¥`;
                alert(msg);
                onClose();
            };
            
            const currentCategories = CATEGORIES[data.slot] || [];

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white w-full max-w-sm rounded-2xl p-6 animate-fade-in shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold tracking-tight">æ–°å¢å–®å“</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-black">âœ•</button>
                        </div>
                        <div className="space-y-6">
                            {/* Slot & Category */}
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-2">éƒ¨ä½èˆ‡é¡åˆ¥</label>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar mb-2 pb-1">
                                    {SLOTS.map(s => (
                                        <button key={s.id} onClick={() => handleSlotChange(s.id)} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap border transition-colors ${data.slot === s.id ? 'bg-black text-white border-black' : 'bg-white text-gray-500 border-gray-200'}`}>{s.label}</button>
                                    ))}
                                </div>
                                <select className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium outline-none focus:border-black mt-2" value={data.category} onChange={e => setData({...data, category: e.target.value})}>
                                    {currentCategories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>

                            {/* Image Upload */}
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-2">å–®å“ç…§ç‰‡</label>
                                <div 
                                    onClick={() => fileInputRef.current.click()}
                                    className={`w-full h-40 border-2 border-dashed rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all overflow-hidden relative group ${data.image ? 'border-black bg-white' : 'border-gray-300 hover:border-gray-400 hover:bg-gray-50'}`}
                                >
                                    {data.image ? (
                                        <>
                                            <img src={data.image} className="w-full h-full object-contain" alt="Preview" />
                                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                <span className="text-white text-xs font-bold">é»æ“Šæ›´æ›</span>
                                            </div>
                                        </>
                                    ) : (
                                        <div className="text-center text-gray-400">
                                            <div className="bg-gray-100 p-3 rounded-full mb-2 mx-auto w-fit">
                                                <Icon name="camera" className="w-6 h-6 text-gray-500" />
                                            </div>
                                            <span className="text-xs font-bold block text-gray-500">ä¸Šå‚³å»èƒŒ PNG</span>
                                            <span className="text-[9px] block mt-1">æ”¯æ´ç›¸æ©Ÿæˆ–æª”æ¡ˆé¸å–</span>
                                        </div>
                                    )}
                                    <input 
                                        type="file" 
                                        ref={fileInputRef} 
                                        onChange={handleFileChange} 
                                        accept="image/png, image/jpeg" 
                                        style={{ display: 'none' }} 
                                    />
                                </div>
                            </div>

                            {/* Colors */}
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-2">ä¸»è¦é¡è‰²</label>
                                <div className="flex gap-3 overflow-x-auto no-scrollbar py-2">
                                    {ALL_COLORS.map(c => (
                                        <div key={c.id} className="flex flex-col items-center gap-1 cursor-pointer group flex-shrink-0" onClick={() => setData({...data, color: c.id})}>
                                            <div 
                                                className={`w-6 h-6 rounded-full transition-all shadow-sm ${data.color === c.id ? 'ring-2 ring-offset-2 ring-black scale-110' : 'hover:scale-105'}`} 
                                                style={{ background: c.hex, border: c.border ? '1px solid #e5e7eb' : 'none' }}
                                            ></div>
                                            <span className={`text-[8px] font-bold ${data.color === c.id ? 'text-black' : 'text-gray-400'}`}>{c.name}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        {/* V13.5: Split Buttons */}
                        <div className="mt-8 flex gap-3">
                            <button 
                                onClick={() => handleSave(false)} 
                                className="flex-1 py-4 bg-white border border-gray-200 text-gray-600 text-xs font-bold tracking-widest uppercase rounded-xl hover:bg-gray-50"
                            >
                                åƒ…åŠ å…¥è¡£æ«¥
                            </button>
                            <button 
                                onClick={() => handleSave(true)} 
                                className="flex-[2] py-4 bg-black text-white text-xs font-bold tracking-widest uppercase rounded-xl hover:bg-gray-900 shadow-lg"
                            >
                                ç©¿ä¸Šä¸¦é è¦½
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const InteractiveMarker = ({ x, y, onClick }) => (
            <div 
                onClick={(e) => { e.stopPropagation(); onClick(); }}
                className="absolute z-50 w-3 h-3 bg-white rounded-full cursor-pointer marker-pulse transform -translate-x-1/2 -translate-y-1/2 hover:scale-150 transition-transform duration-200 shadow-lg"
                style={{ left: `${x}%`, top: `${y}%` }}
            />
        );

        const GhostEngine = ({ outfit, onSlotClick }) => {
            const { coat, outer, inner, bottom, shoes } = outfit;
            const renderMarkers = () => {
                const targetSlots = ['outer', 'inner', 'bottom', 'shoes'];
                return targetSlots.map(sid => {
                    const pos = getSlotDefaultPos(sid);
                    if(pos) return <InteractiveMarker key={sid} x={pos.x} y={pos.y} onClick={() => onSlotClick(sid)} />;
                });
            };

            return (
                <div className="w-full mb-6 flex flex-col items-center animate-fade-in">
                    {/* V13.5: 9:16 Aspect Ratio Container */}
                    <div className="ghost-canvas-container rounded-3xl border border-gray-100 relative bg-white">
                        {shoes && <img src={getAssetUrl(shoes)} className="ghost-layer z-10" alt="Shoes" />}
                        {bottom && <img src={getAssetUrl(bottom)} className="ghost-layer z-20" alt="Bottom" />}
                        {inner && <img src={getAssetUrl(inner)} className="ghost-layer z-30" alt="Inner" />}
                        {(coat || outer) && <img src={getAssetUrl(coat || outer)} className="ghost-layer z-40" alt="Outer" />}
                        {renderMarkers()}
                    </div>
                </div>
            );
        };

        const CritiquePanel = ({ outfit }) => {
            const { outer, inner, bottom, shoes } = outfit;
            
            const analysis = useMemo(() => {
                const items = [outer, inner, bottom, shoes].filter(Boolean);
                if (items.length < 3) return { title: "æº–å‚™å°±ç·’", msg: "ç³»çµ±å¾…å‘½ä¸­...", type: "neutral" };

                const isLeather = outer?.category?.includes('çš®è¡£');
                const isFormalOuter = outer?.category?.includes('è¥¿è£å¤–å¥—');
                const isFormalBottom = bottom?.category?.includes('è¥¿è£è¤²');
                const isDenim = bottom?.category?.includes('ä¸¹å¯§');

                if (isLeather && (isDenim || isFormalBottom)) {
                    return { title: "âœ¨ ç¶“å…¸æ¥µç°¡ (Classic Minimalist)", msg: "åˆ©ç”¨ç¡¬æŒºæè³ªèˆ‡ä¿è½å‰ªè£å½¢æˆå°æ¯”ï¼Œå±•ç¾æˆç†Ÿä¸”æ´—éŠçš„é»ƒé‡‘æ¯”ä¾‹ã€‚", type: "success" };
                }
                
                if (isFormalOuter && isFormalBottom) {
                     return { title: "ğŸ© ç¶“å…¸ç´³å£« (Modern Gentleman)", msg: "æˆå¥—æˆ–åŠæ­£å¼çš„æ­é…ï¼Œå±•ç¾å°ˆæ¥­èˆ‡ç©©é‡æ„Ÿï¼Œé©åˆå•†å‹™æˆ–æ­£å¼å ´åˆã€‚", type: "success" };
                }

                const colors = items.map(i => i.color);
                const isMono = colors.every(c => c === 'black') || colors.every(c => c === 'white') || colors.every(c => c === 'navy');
                if (isMono) {
                    return { title: "âš« æ¥µç°¡åŒè‰²ç³» (Monochrome)", msg: "å…¨èº«åŒè‰²ç³»èƒ½æœ‰æ•ˆå»¶ä¼¸è¦–è¦ºæ¯”ä¾‹ã€‚å»ºè­°æ··æ­ä¸åŒæè³ªï¼ˆå¦‚éœ§é¢èˆ‡äº®é¢ï¼‰å¢åŠ å±¤æ¬¡ã€‚", type: "info" };
                }

                return { title: "ğŸŒ¿ èˆ’é©ä¼‘é–’ (Relaxed Casual)", msg: "çµæ§‹ç©©å®šçš„æ—¥å¸¸æ­é…ã€‚å¯å˜—è©¦æ›´æ›å…§æ­é¡è‰²æˆ–é‹æ¬¾é¢¨æ ¼ï¼Œç‚ºé€ å‹å¢æ·»äº®é»ã€‚", type: "neutral" };
            }, [outfit]);

            return (
                <div className={`w-full rounded-xl p-5 border shadow-lg transition-all duration-500 animate-fade-in ${analysis.type === 'success' ? 'bg-gray-900 text-white border-gray-800' : 'bg-white text-gray-800 border-gray-200'}`}>
                    <div className="flex items-start gap-3">
                        <div className={`mt-0.5 p-1.5 rounded-full ${analysis.type === 'success' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-gray-100 text-gray-500'}`}>
                            <Icon name="star" className="w-4 h-4" />
                        </div>
                        <div>
                            <h4 className="text-xs font-bold uppercase tracking-widest mb-1">{analysis.title}</h4>
                            <p className="text-sm leading-relaxed opacity-90">{analysis.msg}</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 5. MAIN APPLICATION ---
        const App = () => {
            const [wardrobe, setWardrobe] = useState(() => {
                try {
                    const saved = localStorage.getItem(WARDROBE_KEY);
                    if (saved) {
                        let parsed = JSON.parse(saved);
                        if (parsed && Array.isArray(parsed)) {
                            // Patch legacy
                            parsed = parsed.map(item => ({
                                ...item,
                                color: item.color || 'black', 
                                category: item.category || 'æœªåˆ†é¡å–®å“',
                                id: item.id || Date.now() + Math.random()
                            }));
                            return parsed.length > 0 ? parsed : DEFAULT_WARDROBE;
                        }
                    }
                } catch (e) { console.error("Data Load Error"); }
                return DEFAULT_WARDROBE;
            });

            const [outfit, setOutfit] = useState(DEFAULT_OUTFIT);
            const [pickingSlot, setPickingSlot] = useState(null);
            const [activeTab, setActiveTab] = useState('align');
            const [inventoryTab, setInventoryTab] = useState('outer'); 
            const [showAddModal, setShowAddModal] = useState(false);

            useEffect(() => { localStorage.setItem(WARDROBE_KEY, JSON.stringify(wardrobe)); }, [wardrobe]);

            const handleReset = () => {
                if(confirm("âš ï¸ ç¢ºå®šé‡ç½®ï¼Ÿé€™å°‡æ¸…é™¤æ‚¨æ‰€æœ‰çš„è‡ªè¨‚å–®å“è³‡æ–™ã€‚")) {
                    setWardrobe(DEFAULT_WARDROBE);
                    setOutfit(DEFAULT_OUTFIT);
                    window.location.reload();
                }
            };

            // V13.5: Modified to accept equip boolean
            const handleAddItem = (newItem, shouldEquip) => {
                setWardrobe(prev => [...prev, newItem]);
                if (shouldEquip) {
                    setOutfit(prev => ({ ...prev, [newItem.slot]: newItem })); 
                }
            };

            const handleRandomStyle = () => {
                const newOutfit = { ...outfit }; 
                const targets = ['outer', 'inner', 'bottom', 'shoes'];
                let filledCount = 0;

                targets.forEach(slot => {
                    if (outfit[slot] || (slot === 'outer' && outfit.coat)) return; 

                    const candidates = wardrobe.filter(item => item.slot === slot || (slot === 'outer' && item.slot === 'coat'));
                    if (candidates.length > 0) {
                        const randomItem = candidates[Math.floor(Math.random() * candidates.length)];
                        newOutfit[slot] = randomItem;
                        filledCount++;
                    }
                });
                
                if (filledCount === 0) {
                    alert("âš ï¸ æç¤ºï¼šç›®å‰æ‰€æœ‰éƒ¨ä½éƒ½å·²ç©¿ä¸Šã€‚è«‹å…ˆç§»é™¤éƒ¨åˆ†å–®å“ï¼ŒAI æ‰èƒ½ç‚ºæ‚¨éš¨æ©Ÿå¡«è£œã€‚");
                } else {
                    setOutfit(newOutfit);
                }
            };

            const handleClearAll = () => {
                setOutfit({ coat: null, outer: null, inner: null, bottom: null, shoes: null, bag: null, jewelry: null });
            };

            const handleClearSlot = (slot) => {
                setOutfit(prev => ({ ...prev, [slot]: null }));
            };

            const renderItemCard = (item, onClick, isSelected, onDelete) => {
                const color = ALL_COLORS.find(c => c.id === item.color) || ALL_COLORS[0];
                const catLabel = item.category ? item.category : 'æœªçŸ¥';
                return (
                    <div key={item.id} onClick={() => onClick(item)} className={`p-3 bg-white rounded-xl border relative cursor-pointer transition-all ${isSelected ? 'border-black shadow-md bg-gray-50' : 'border-gray-100 hover:border-gray-300'}`}>
                        <div className="flex justify-between items-start mb-2">
                            <span className="text-[9px] font-bold uppercase text-gray-400">{item.slot}</span>
                            <div className="w-3 h-3 rounded-full border border-gray-200" style={{background: color.hex}}></div>
                        </div>
                        <div className="font-bold text-xs text-gray-900 truncate">{catLabel}</div>
                        {item.image && <span className="absolute top-1 right-6 text-[8px] bg-gray-100 px-1 rounded text-gray-500">IMG</span>}
                        {onDelete && <button onClick={(e)=>{e.stopPropagation(); onDelete(item.id)}} className="absolute top-1 right-1 p-1 text-gray-300 hover:text-red-500"><Icon name="trash" className="w-3 h-3"/></button>}
                        {isSelected && <div className="absolute bottom-1 right-1 text-black"><Icon name="check" className="w-3 h-3"/></div>}
                    </div>
                );
            };

            const renderPicker = () => {
                if (!pickingSlot) return null;
                const items = wardrobe.filter(i => i.slot === pickingSlot || (pickingSlot === 'outer' && i.slot === 'coat')); 
                return (
                    <div className="fixed inset-0 bg-white z-50 flex flex-col animate-fade-in">
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center pt-12 md:pt-6">
                            <h3 className="font-bold text-lg uppercase">é¸æ“‡ {pickingSlot}</h3>
                            <button onClick={() => setPickingSlot(null)} className="text-sm font-bold text-gray-400">é—œé–‰</button>
                        </div>
                        <div className="p-6 grid grid-cols-2 gap-3 overflow-y-auto pb-24">
                            <div onClick={() => { setOutfit({...outfit, [pickingSlot]: null}); setPickingSlot(null); }} className="p-4 border-2 border-dashed border-gray-200 rounded-xl flex items-center justify-center cursor-pointer text-gray-400 text-xs font-bold">å¸ä¸‹ (NONE)</div>
                            {items.map(item => renderItemCard(item, (i) => { setOutfit({...outfit, [pickingSlot]: i}); setPickingSlot(null); }, outfit[pickingSlot]?.id === item.id))}
                        </div>
                    </div>
                );
            };

            const currentFilteredWardrobe = wardrobe.filter(item => {
                const activeTab = INVENTORY_TABS.find(t => t.id === inventoryTab);
                return activeTab ? activeTab.slots.includes(item.slot) : true;
            });

            return (
                <div className="app-container">
                    <div className="px-6 pt-8 pb-4 bg-white border-b border-gray-100 flex justify-between items-center z-10 sticky top-0">
                        <h1 className="text-lg font-bold tracking-tighter flex items-center gap-2">
                            Minimalist 
                            <span className="bg-black text-white text-[10px] px-2 py-0.5 rounded-full shadow-sm">V13.5</span>
                        </h1>
                        <div className="flex gap-2">
                            <button onClick={() => setActiveTab('wardrobe')} className={`text-[10px] font-bold px-3 py-1.5 rounded-full transition-colors ${activeTab==='wardrobe' ? 'bg-black text-white' : 'bg-gray-100 text-gray-400'}`}>è¡£æ«¥</button>
                            <button onClick={() => setActiveTab('align')} className={`text-[10px] font-bold px-3 py-1.5 rounded-full transition-colors ${activeTab==='align' ? 'bg-black text-white' : 'bg-gray-100 text-gray-400'}`}>æ ¡æº–</button>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto no-scrollbar p-6 relative">
                        {activeTab === 'align' && (
                            <>
                                <GhostEngine outfit={outfit} onSlotClick={setPickingSlot} />
                                <CritiquePanel outfit={outfit} />
                                
                                <div className="mt-6 flex gap-2">
                                    <button 
                                        onClick={handleClearAll}
                                        className="flex-1 py-4 bg-white border border-gray-200 text-gray-500 text-xs font-bold tracking-widest uppercase rounded-xl hover:bg-gray-50 flex items-center justify-center gap-2 active:scale-95 transition-transform"
                                    >
                                        <Icon name="trash" className="w-4 h-4" /> å…¨éƒ¨è„«ä¸‹
                                    </button>
                                    <button 
                                        onClick={handleRandomStyle}
                                        className="flex-[2] py-4 bg-black text-white text-xs font-bold tracking-widest uppercase rounded-xl hover:bg-gray-900 shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95"
                                    >
                                        <Icon name="dice" className="w-5 h-5" /> éš¨æ©Ÿè£œä½ (AI)
                                    </button>
                                </div>

                                <div className="grid grid-cols-4 gap-2 mt-8 opacity-50 hover:opacity-100 transition-opacity pb-8">
                                    {['outer','inner','bottom','shoes'].map(slot => (
                                        <div key={slot} className="relative group">
                                            <div onClick={() => setPickingSlot(slot)} className={`aspect-square rounded-xl border flex flex-col items-center justify-center cursor-pointer transition-all ${outfit[slot] ? 'bg-white border-black' : 'bg-gray-100 border-transparent'}`}>
                                                <span className="text-[9px] font-bold uppercase text-gray-400 mb-1">{SLOTS.find(s=>s.id===slot)?.label}</span>
                                                {outfit[slot] ? <div className="w-3 h-3 rounded-full border border-gray-200" style={{background: ALL_COLORS.find(c=>c.id===outfit[slot].color)?.hex}}></div> : <Icon name="plus" className="w-4 h-4 text-gray-300"/>}
                                            </div>
                                            {outfit[slot] && (
                                                <button 
                                                    onClick={() => handleClearSlot(slot)}
                                                    className="absolute -top-2 -right-2 bg-gray-200 text-gray-600 rounded-full p-1 shadow hover:bg-red-100 hover:text-red-500 transition-colors z-20"
                                                >
                                                    <Icon name="x" className="w-3 h-3" />
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}

                        {activeTab === 'wardrobe' && (
                            <div className="pb-24 flex flex-col min-h-full">
                                <div className="flex gap-2 mb-6 overflow-x-auto no-scrollbar">
                                    {INVENTORY_TABS.map(tab => (
                                        <button 
                                            key={tab.id} 
                                            onClick={() => setInventoryTab(tab.id)}
                                            className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${inventoryTab === tab.id ? 'bg-black text-white' : 'bg-white text-gray-400 border border-gray-100'}`}
                                        >
                                            {tab.label}
                                        </button>
                                    ))}
                                </div>

                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xs font-bold text-gray-400 uppercase tracking-widest">
                                        {INVENTORY_TABS.find(t=>t.id===inventoryTab)?.label} ({currentFilteredWardrobe.length})
                                    </h2>
                                </div>

                                {currentFilteredWardrobe.length > 0 ? (
                                    <div className="grid grid-cols-2 gap-3 mb-8">
                                        {currentFilteredWardrobe.map(item => renderItemCard(
                                            item, 
                                            (clickedItem) => setOutfit(prev => ({...prev, [clickedItem.slot]: clickedItem})), 
                                            outfit[item.slot]?.id === item.id,
                                            (id) => setWardrobe(w => w.filter(x => x.id !== id))
                                        ))}
                                    </div>
                                ) : (
                                    <div className="py-12 text-center text-gray-400 text-xs border-2 border-dashed border-gray-200 rounded-xl mb-8">
                                        å°šç„¡å–®å“
                                    </div>
                                )}
                                
                                <button onClick={() => setShowAddModal(true)} className="absolute bottom-6 right-6 w-14 h-14 bg-black text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-105 transition-transform z-30 cursor-pointer border border-gray-800"><Icon name="plus" className="w-6 h-6" /></button>

                                <div className="mt-auto border-t border-gray-200 pt-6 flex justify-center gap-4">
                                    <button onClick={() => { const data = JSON.stringify(wardrobe); navigator.clipboard.writeText(data).then(() => alert("âœ… è³‡æ–™å·²è¤‡è£½")); }} className="flex items-center gap-1 text-[10px] text-gray-500 font-bold hover:text-black"><Icon name="download" className="w-3 h-3"/> åŒ¯å‡º</button>
                                    <button onClick={handleReset} className="text-[10px] text-red-400 font-bold hover:text-red-600 underline">é‡ç½®</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {renderPicker()}
                    <AddItemModal isOpen={showAddModal} onClose={() => setShowAddModal(false)} onAdd={handleAddItem} />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>