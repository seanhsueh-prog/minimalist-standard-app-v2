<!-- minimalist-wardrobe-core_v27_0.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minimalist V27.0 - Smart Parsing Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* [V27.0 - Visuals based on V26.5] */
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            -webkit-font-smoothing: antialiased; 
            background-color: #111; 
            color: #111; 
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center; 
            align-items: flex-start;
        }
        
        .app-container {
            width: 100%;
            max-width: 480px; 
            height: 100vh; 
            background-color: #ffffff;
            position: relative;
            box-shadow: 0 0 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 80px; 
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .content-area::-webkit-scrollbar { display: none; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .ghost-canvas-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4 / 5; 
            background-color: #f9fafb;
            overflow: hidden;
            border-bottom: 1px solid #f0f0f0;
        }

        .ghost-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; 
            object-position: bottom center;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
            will-change: transform, opacity; 
        }

        /* Floating Control Stack */
        .floating-controls {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-40%); 
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 30;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            border-radius: 99px; 
            padding: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .mini-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: #9ca3af;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            margin-bottom: 2px;
        }
        .mini-btn:last-child { margin-bottom: 0; }
        
        .mini-btn.active {
            background-color: #000;
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Dense Card */
        .dense-card {
            aspect-ratio: 1/1;
            position: relative;
            background: #fff;
            border-radius: 0.75rem;
            border: 1px solid #f3f4f6;
            overflow: hidden; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s;
            padding: 0; 
        }
        .dense-card:active { transform: scale(0.98); }
        .dense-card img { width: 100%; height: 100%; object-fit: contain; padding: 2px; }

        /* Warehouse Items */
        .warehouse-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            padding-bottom: 2rem;
        }
        .warehouse-item {
            aspect-ratio: 3/4;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 0; 
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: #fff;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .warehouse-item:active { transform: scale(0.98); border-color: #000; }
        .warehouse-item img { width: 100%; height: 100%; object-fit: contain; padding: 8px; }

        /* Category Pills */
        .cat-pill {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s;
            border: 1px solid #eee;
            cursor: pointer;
        }
        .cat-pill.active {
            background-color: #000;
            color: #fff;
            border-color: #000;
        }
        .cat-pill.inactive {
            background-color: #fff;
            color: #666;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 12px 0 24px 0; 
            z-index: 50;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 600;
            color: #9ca3af;
            cursor: pointer;
            transition: color 0.2s;
            flex: 1;
        }
        .nav-item.active {
            color: #000;
        }
        .nav-item svg {
            transition: transform 0.2s;
        }
        .nav-item:active svg {
            transform: scale(0.9);
        }
    </style>
</head>
<body>
    <div id="root" class="w-full flex justify-center"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- 1. CORE UTILS: IndexedDB & Migration ---
        const APP_VERSION = 'v27.0';
        const DB_CONFIG = { name: 'MinimalistVault_V27', version: 1, store: 'inventory' };

        // Helper to clear old data
        const checkMigration = async () => {
            const current = localStorage.getItem('app_version');
            if (current !== APP_VERSION) {
                console.log('Migrating to', APP_VERSION);
                try {
                    // Simple logic: If version changed, we might want to clear old incompatible DBs
                    // For V27, we enforce a clean slate due to new naming convention
                    const dbs = await window.indexedDB.databases();
                    dbs.forEach(db => { if (db.name !== DB_CONFIG.name) window.indexedDB.deleteDatabase(db.name); });
                    localStorage.setItem('app_version', APP_VERSION);
                } catch (e) { console.error("Migration warning", e); }
            }
        };

        const dbHelper = {
            open: () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(DB_CONFIG.store)) {
                            db.createObjectStore(DB_CONFIG.store, { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            addItem: async (item) => {
                const db = await dbHelper.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(DB_CONFIG.store, 'readwrite');
                    const store = tx.objectStore(DB_CONFIG.store);
                    const request = store.add(item);
                    request.onsuccess = () => resolve({ ...item, id: request.result });
                    request.onerror = () => reject(request.error);
                });
            },
            getAllItems: async () => {
                const db = await dbHelper.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(DB_CONFIG.store, 'readonly');
                    const store = tx.objectStore(DB_CONFIG.store);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            deleteItem: async (id) => {
                const db = await dbHelper.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(DB_CONFIG.store, 'readwrite');
                    const store = tx.objectStore(DB_CONFIG.store);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        };

        // --- 2. NEW CATEGORY & ASSET MAP (V27.0) ---
        const PART_MAP = {
            'outer': 'o', 'inner': 'i', 'bottom': 'b', 'shoes': 's'
        };

        const CATEGORY_MAP = {
            // Outer
            'suits': 'ÂñÆÊéíË•øË£ù', 'suitd': 'ÈõôÊéíË•øË£ù', 'coat': 'Â§ßË°£', 
            'leather': 'ÁöÆË°£', 'jacket': 'Â§æÂÖã', 'down': 'ÁæΩÁµ®',
            // Inner (s=sleeved, n=no sleeve)
            'shirts': 'ÊúâË¢ñË•ØË°´', 'shirtn': 'ÁÑ°Ë¢ñË•ØË°´',
            'tshirts': 'ÊúâË¢ñTÊÅ§', 'tshirtn': 'ÁÑ°Ë¢ñTÊÅ§',
            'polos': 'ÊúâË¢ñPolo', 'polon': 'ÁÑ°Ë¢ñPolo',
            'knits': 'ÊúâË¢ñÈáùÁπî', 'knitn': 'ÁÑ°Ë¢ñÈáùÁπî',
            'hoodies': 'ÊúâË¢ñÂ∏ΩT', 'hoodien': 'ÁÑ°Ë¢ñÂ∏ΩT',
            'sweats': 'ÊúâË¢ñË°õË°£', 'sweatn': 'ÁÑ°Ë¢ñË°õË°£',
            // Bottom
            'suit': 'Ë•øË£ùË§≤', 'jeans': 'Áâõ‰ªîË§≤', 'chino': 'Âç°ÂÖ∂Ë§≤', 
            'shorts': 'Áü≠Ë§≤', 'sport': 'ÈÅãÂãïË§≤', 'cargo': 'Â∑•Ë£ùË§≤',
            // Shoes
            'dress': 'ÁöÆÈûã', 'loafer': 'Ê®ÇÁ¶èÈûã', 'leasnk': 'ÁöÆÈù©‰ºëÈñí', 
            'sport': 'ÈÅãÂãïÈûã', 'boots': 'Èù¥Â≠ê'
        };

        const COLOR_MAP = {
            'bk': { hex: '#1A1A1A', label: 'Èªë' },
            'wh': { hex: '#FFFFFF', label: 'ÁôΩ', border: true },
            'gy': { hex: '#808080', label: 'ÁÅ∞' },
            'nv': { hex: '#1E3A8A', label: 'Ê∑±Ëóç' },
            'be': { hex: '#C3B091', label: 'Á±≥/Â§ßÂú∞' },
            'br': { hex: '#5D4037', label: 'Ê£ï' },
            'dn': { hex: '#3B82F6', label: '‰∏πÂØß' },
            'gn': { hex: '#355E3B', label: 'ËªçÁ∂†' },
            'rd': { hex: '#7F1D1D', label: 'ÈÖíÁ¥Ö' }
        };

        const STYLE_RULES = {
            // Mapping categories to occasions for smart styling
            'suits': ['Formal', 'Smart'], 'suitd': ['Formal', 'Smart'], 'coat': ['Formal', 'Smart'], 
            'leather': ['Smart', 'Casual'], 'jacket': ['Smart', 'Casual'], 'down': ['Casual'],
            'shirts': ['Formal', 'Smart'], 'shirtn': ['Formal', 'Smart'], 
            'tshirts': ['Smart', 'Casual'], 'tshirtn': ['Smart', 'Casual'],
            'suit': ['Formal', 'Smart'], 'jeans': ['Smart', 'Casual'], 'chino': ['Smart', 'Casual'],
            'shorts': ['Casual'], 'sport': ['Casual'], 'cargo': ['Casual'],
            'dress': ['Formal', 'Smart'], 'loafer': ['Formal', 'Smart'], 'leasnk': ['Smart', 'Casual'],
            'sport': ['Casual'], 'boots': ['Smart', 'Casual']
        };

        const SLOTS = [
            { id: 'coat', label: 'Â§ßË°£' }, { id: 'outer', label: 'Â§ñÂ•ó' }, { id: 'inner', label: 'ÂÖßÊê≠' },
            { id: 'bottom', label: '‰∏ãË∫´' }, { id: 'shoes', label: 'ÈûãÊ¨æ' }
        ];

        const OCCASIONS = [ { id: 'Formal', label: 'Ê≠£Âºè' }, { id: 'Smart', label: 'Â§ß‰∫∫' }, { id: 'Casual', label: '‰ºëÈñí' } ];
        const SEASONS = [ { id: 'Winter', label: 'ÂÜ¨Â≠£' }, { id: 'Summer', label: 'Â§èÂ≠£' } ];

        // --- 3. HELPER FUNCTIONS ---
        // V27.0: Filename Parser
        const parseFilename = (filename) => {
            // Expected format: part_category_color_id.png (e.g., o_suits_bk_01.png)
            const parts = filename.replace('.png', '').split('_');
            if (parts.length < 4) return null;
            return {
                partCode: parts[0],
                catCode: parts[1],
                colorCode: parts[2],
                id: parts[3],
                full: filename
            };
        };

        // --- 4. ICONS ---
        const Icon = ({ name, className }) => {
            const icons = {
                hanger: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2a5 5 0 0 1 4.9 6H7.1a5 5 0 0 1 4.9-6Z"/><path d="M21 21H3V11c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v10Z"/></svg>,
                grid: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
                bag: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
                trash: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
                dice: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/><circle cx="8" cy="16" r="1.5" fill="currentColor"/><circle cx="16" cy="8" r="1.5" fill="currentColor"/></svg>,
                x: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
                plus: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>
            };
            return icons[name] ? React.cloneElement(icons[name], { className }) : null;
        };

        // --- 5. COMPONENTS ---

        const GhostEngine = ({ outfit, occasion, setOccasion, season, setSeason, triggerRandom, onGoToWarehouse }) => {
            const { coat, outer, inner, bottom, shoes } = outfit;
            return (
                <div className="w-full mb-0 flex justify-center items-center animate-fade-in bg-white relative">
                    <div className="ghost-canvas-container mx-auto relative">
                        {shoes && (
                            <img 
                                src={shoes.displayUrl} 
                                className="ghost-layer z-10" 
                                alt="Shoes" 
                                style={{ transform: 'translateZ(0)' }} 
                                onError={(e) => e.target.style.display='none'} 
                            />
                        )}
                        {bottom && <img src={bottom.displayUrl} className="ghost-layer z-20" alt="Bottom" onError={(e) => e.target.style.display='none'} />}
                        {inner && <img src={inner.displayUrl} className="ghost-layer z-30" alt="Inner" onError={(e) => e.target.style.display='none'} />}
                        {(coat || outer) && <img src={coat?.displayUrl || outer?.displayUrl} className="ghost-layer z-40" alt="Outer" onError={(e) => e.target.style.display='none'} />}
                        
                        {(!shoes && !bottom && !inner && !outer && !coat) && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center z-20 pointer-events-auto">
                                <p className="text-gray-300 text-xs tracking-widest mb-4">ÊÇ®ÁöÑË°£Ê´•ÁõÆÂâçÊòØÁ©∫ÁöÑ</p>
                                <button onClick={onGoToWarehouse} className="px-4 py-2 bg-black text-white text-xs font-bold rounded-full shadow-lg hover:scale-105 transition-transform">
                                    üí° ÂâçÂæÄÂñÆÂìÅÂÄâÂ∫´Êñ∞Â¢ûÂñÆÂìÅ
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="floating-controls">
                        <div className="control-group mb-3">
                            {SEASONS.map(s => (
                                <button key={s.id} className={`mini-btn ${season === s.id ? 'active' : ''}`} onClick={() => { setSeason(s.id); triggerRandom(occasion, s.id); }} title={s.label}>{s.label.slice(0, 1)}</button>
                            ))}
                        </div>
                        <div className="control-group">
                            {OCCASIONS.map(occ => (
                                <button key={occ.id} className={`mini-btn ${occasion === occ.id ? 'active' : ''}`} onClick={() => { setOccasion(occ.id); triggerRandom(occ.id, season); }} title={occ.label}>{occ.label.slice(0, 2)}</button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 6. MAIN APPLICATION ---
        const App = () => {
            const [wardrobe, setWardrobe] = useState([]);
            const [outfit, setOutfit] = useState(DEFAULT_OUTFIT);
            const [activeTab, setActiveTab] = useState('styling');
            const [dbError, setDbError] = useState(false);
            
            const [occasion, setOccasion] = useState('Smart'); 
            const [season, setSeason] = useState('Winter');
            const [inventoryTab, setInventoryTab] = useState('outer');
            
            // New V27 Warehouse State
            const [whSlot, setWhSlot] = useState('outer');
            const [whCatCode, setWhCatCode] = useState('suits'); // Use real code (e.g. 'suits')
            const [whColorCode, setWhColorCode] = useState('bk'); // Use real code (e.g. 'bk')
            const [whInnerSleeve, setWhInnerSleeve] = useState('s'); // s or n

            // Init
            useEffect(() => { 
                checkMigration();
                loadData(); 
            }, []);

            const loadData = async () => {
                try {
                    const items = await dbHelper.getAllItems();
                    setWardrobe(items);
                } catch (e) {
                    console.error("DB Load Failed:", e);
                    setDbError(true);
                }
            };

            // V27.0: Virtual Stock Generator
            // This generates potential file paths based on the selection to show in the grid
            const getVirtualStock = () => {
                // Construct category code based on logic
                let targetCat = whCatCode;
                
                // Special handling for inner logic (append 's' or 'n' to base cat if needed)
                // Actually, the new map has distinct codes: 'shirts', 'shirtn'.
                // So we need to switch whCatCode based on sleeve toggle if we are in inner slot.
                
                const prefix = PART_MAP[whSlot];
                const count = 3; // Assume 3 variants per color/cat
                
                // Generate
                const stock = [];
                for(let i=1; i<=count; i++) {
                    const num = i.toString().padStart(2, '0');
                    const fname = `${prefix}_${targetCat}_${whColorCode}_${num}.png`;
                    stock.push({
                        src: fname,
                        displayUrl: `./${fname}`, // Relative path assumption
                        slot: whSlot,
                        category: CATEGORY_MAP[targetCat] || targetCat,
                        color: whColorCode,
                        catCode: targetCat
                    });
                }
                return stock;
            };

            const handleAddItem = async (stockItem) => {
                // Build the item record
                // Parse style from map
                let styles = STYLE_RULES[stockItem.catCode] || ['Casual'];
                // Clean up sleeve logic for storage
                let sleeveType = 'standard';
                if (whSlot === 'inner') {
                    sleeveType = whCatCode.endsWith('n') ? 'sleeveless' : 'sleeved';
                }

                const newItem = {
                    id: Date.now(), // Temp ID, DB will overwrite
                    slot: whSlot,
                    image: stockItem.src, // Store filename
                    displayUrl: stockItem.displayUrl,
                    category: stockItem.category,
                    catCode: stockItem.catCode,
                    color: whColorCode, // Store code 'bk'
                    sleeve: sleeveType,
                    style: styles,
                    createdAt: Date.now()
                };

                try {
                    await dbHelper.addItem(newItem);
                    await loadData();
                    // Optional: simple toast or feedback could go here
                } catch (e) { alert("ÂÑ≤Â≠òÂ§±Êïó"); }
            };

            const handleDeleteItem = async (id) => {
                if(!confirm("Á¢∫ÂÆöÁßªÈô§Ê≠§ÂñÆÂìÅÔºü")) return;
                try {
                    await dbHelper.deleteItem(id);
                    await loadData();
                    setOutfit(prev => {
                        const next = { ...prev };
                        Object.keys(next).forEach(k => { if (next[k]?.id === id) next[k] = null; });
                        return next;
                    });
                } catch (e) { alert("Âà™Èô§Â§±Êïó"); }
            };

            const handleClearSlot = (slot) => setOutfit(prev => ({ ...prev, [slot]: null }));
            const handleClearAll = () => setOutfit(DEFAULT_OUTFIT);

            const handleRandom = useCallback((targetOccasion = occasion, targetSeason = season) => {
                const newOutfit = { ...outfit };
                const slots = ['outer', 'inner', 'bottom', 'shoes'];
                let forceOuterOff = false;
                if (targetSeason === 'Summer') {
                    if (targetOccasion === 'Formal') { /* Allow */ } 
                    else { newOutfit.outer = null; newOutfit.coat = null; forceOuterOff = true; }
                }
                slots.forEach(slot => {
                    if (newOutfit[slot]) {
                         if (slot === 'outer' && forceOuterOff) {} else { return; }
                    }
                    if (forceOuterOff && slot === 'outer') return;
                    
                    // Filter Wardrobe
                    let candidates = wardrobe.filter(item => item.slot === slot || (slot === 'outer' && item.slot === 'coat'));
                    
                    // Style Filter
                    candidates = candidates.filter(item => item.style && item.style.includes(targetOccasion));
                    
                    // Inner Sleeve Logic
                    if (slot === 'inner') {
                        const hasOuter = newOutfit.outer || newOutfit.coat; 
                        candidates = candidates.filter(i => hasOuter ? i.sleeve === 'sleeveless' : i.sleeve === 'sleeved');
                        if (targetSeason === 'Summer') candidates = candidates.filter(i => !['ÊØõË°£/ÈáùÁπî', 'Â∏ΩT/Ë°õË°£'].includes(i.category)); // Rough check by name
                    }
                    
                    // Suit Logic
                    if (targetOccasion === 'Formal' && slot === 'bottom' && newOutfit.outer) {
                        const suitMatch = candidates.filter(b => b.color === newOutfit.outer.color); // Color code matching
                        if (suitMatch.length > 0) candidates = suitMatch;
                    }
                    
                    // Shoes Logic
                    if (targetOccasion === 'Smart' && slot === 'shoes' && newOutfit.bottom && newOutfit.bottom.catCode === 'suit') {
                        candidates = candidates.filter(s => s.catCode !== 'sport');
                    }

                    if (candidates.length > 0) newOutfit[slot] = candidates[Math.floor(Math.random() * candidates.length)];
                    else newOutfit[slot] = null;
                });
                setOutfit(newOutfit);
            }, [outfit, wardrobe, occasion, season]);

            // Handling Inner Category Switch (Base + Sleeve suffix)
            const handleInnerCatChange = (base) => {
                // Base is like 'shirt', 'tshirt'. We add 's' or 'n' based on whInnerSleeve
                setWhCatCode(base + whInnerSleeve);
            };
            
            // Update cat code when sleeve toggles
            useEffect(() => {
                if (whSlot === 'inner') {
                    const currentBase = whCatCode.slice(0, -1); // remove last char
                    // Need to ensure currentBase is valid
                    if (['shirt','tshirt','polo','knit','hoodie','sweat'].includes(currentBase)) {
                        setWhCatCode(currentBase + whInnerSleeve);
                    }
                }
            }, [whInnerSleeve]);

            // Categories available for current slot
            const getCurrentCategories = () => {
                if (whSlot === 'outer') return ['suits','suitd','coat','leather','jacket','down'];
                if (whSlot === 'bottom') return ['suit','jeans','chino','shorts','sport','cargo'];
                if (whSlot === 'shoes') return ['dress','loafer','leasnk','sport','boots'];
                if (whSlot === 'inner') return ['shirt','tshirt','polo','knit','hoodie','sweat']; // Base names
                return [];
            };

            // Custom handler to reset categories when slot changes
            const handleSlotTabChange = (s) => {
                setWhSlot(s);
                if (s === 'outer') setWhCatCode('suits');
                if (s === 'bottom') setWhCatCode('suit');
                if (s === 'shoes') setWhCatCode('dress');
                if (s === 'inner') {
                    setWhInnerSleeve('s');
                    setWhCatCode('shirts');
                }
            };

            return (
                <div className="app-container">
                    {dbError && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 p-6 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-2xl p-6 text-center max-w-xs shadow-2xl">
                                <h3 className="text-lg font-bold mb-2 text-red-600">‚ö†Ô∏è ÁÄèË¶ΩÂô®ÈôêÂà∂</h3>
                                <p className="text-sm text-gray-600 mb-6 text-left">Ë´ãÈóúÈñâ Safari ÁßÅÂØÜÁÄèË¶ΩÊ®°Âºè‰ª•Á¢∫‰øùË≥áÊñôÂ∫´Ê≠£Â∏∏ÈÅã‰Ωú„ÄÇ</p>
                                <button onClick={() => window.location.reload()} className="w-full py-3 bg-black text-white text-sm font-bold rounded-xl">ÈáçË©¶</button>
                            </div>
                        </div>
                    )}

                    <div className="px-6 pt-6 pb-2 bg-white border-b border-gray-100 flex justify-between items-center z-10 sticky top-0">
                        <h1 className="text-lg font-bold tracking-tighter flex items-center gap-2">Minimalist <span className="bg-black text-white text-[10px] px-2 py-0.5 rounded-full shadow-sm">V27.0</span></h1>
                    </div>

                    <div className="content-area bg-gray-50">
                        {activeTab === 'styling' && (
                            <div className="animate-fade-in">
                                <GhostEngine 
                                    outfit={outfit} occasion={occasion} setOccasion={setOccasion} season={season} setSeason={setSeason} 
                                    triggerRandom={handleRandom} onGoToWarehouse={() => setActiveTab('add')} 
                                />
                                <div className="px-6 mt-4 mb-4">
                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {['outer','inner','bottom','shoes'].map(slot => (
                                            <div key={slot} className="relative group">
                                                <div className={`aspect-square rounded-xl border flex flex-col items-center justify-center cursor-pointer transition-all overflow-hidden relative ${outfit[slot] ? 'bg-white border-black' : 'bg-gray-100 border-dashed border-gray-300'}`}>
                                                    {outfit[slot] ? (
                                                        <div className={`w-full h-full overflow-hidden ${slot === 'shoes' ? '' : 'p-2 flex items-center justify-center'}`}>
                                                            <img 
                                                                src={outfit[slot].displayUrl} 
                                                                className="w-full h-full"
                                                                style={slot === 'shoes' || (outfit[slot].image && outfit[slot].image.startsWith('s_')) 
                                                                    ? { width: '100%', height: '100%', objectFit: 'contain', transform: 'scale(3.8) translateZ(0)', transformOrigin: 'bottom center', willChange: 'transform' } 
                                                                    : { objectFit: 'contain' }
                                                                }
                                                                alt={slot}
                                                            />
                                                        </div>
                                                    ) : (
                                                        <>
                                                            <span className="text-[9px] font-bold uppercase text-gray-400 mb-1">{SLOTS.find(s=>s.id===slot)?.label}</span>
                                                            <span className="text-xs text-gray-300 font-bold">+</span>
                                                        </>
                                                    )}
                                                </div>
                                                {outfit[slot] && <button onClick={() => handleClearSlot(slot)} className="absolute -top-2 -right-2 bg-white border border-gray-200 text-gray-400 rounded-full p-1 shadow hover:text-red-500 z-20"><Icon name="x" className="w-3 h-3" /></button>}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={handleClearAll} className="flex-1 py-3 bg-white border border-gray-200 text-gray-500 text-xs font-bold tracking-widest uppercase rounded-xl hover:bg-gray-50 flex items-center justify-center gap-2 active:scale-95 transition-transform"><Icon name="trash" className="w-4 h-4" /> ÈáçÁΩÆÁ©øÊê≠</button>
                                        <button onClick={() => handleRandom(occasion, season)} className="flex-[2] py-3 bg-black text-white text-xs font-bold tracking-widest uppercase rounded-xl hover:bg-gray-900 shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95"><Icon name="dice" className="w-4 h-4" /> Êô∫ÊÖßÊê≠ÈÖç</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'closet' && (
                            <div className="p-6 animate-fade-in min-h-full bg-white">
                                <h2 className="text-xl font-bold mb-4">ÊàëÁöÑË°£Ê´•</h2>
                                <div className="flex gap-2 mb-6 overflow-x-auto no-scrollbar">
                                    {INVENTORY_TABS.map(tab => (
                                        <button key={tab.id} onClick={() => setInventoryTab(tab.id)} className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${inventoryTab === tab.id ? 'bg-black text-white' : 'bg-gray-100 text-gray-400'}`}>{tab.label}</button>
                                    ))}
                                </div>
                                <div className="grid grid-cols-3 gap-2">
                                    {wardrobe.filter(item => INVENTORY_TABS.find(t => t.id === inventoryTab)?.slots.includes(item.slot)).map(item => (
                                        <div key={item.id} onClick={() => { setOutfit(prev => ({...prev, [item.slot]: item})); setActiveTab('styling'); }} className="dense-card cursor-pointer overflow-hidden relative group">
                                            <img 
                                                src={item.displayUrl} 
                                                alt={item.category}
                                                style={item.slot === 'shoes' || item.image.startsWith('s_')
                                                    ? { width: '100%', height: '100%', objectFit: 'contain', transform: 'scale(3.5)', transformOrigin: 'bottom center', padding: 0 } 
                                                    : {}}
                                            />
                                            <div className="absolute bottom-1 right-1 w-2 h-2 rounded-full border border-gray-100 shadow-sm" style={{ background: COLOR_MAP[item.color]?.hex || '#000' }}></div>
                                            <button onClick={(e) => { e.stopPropagation(); handleDeleteItem(item.id); }} className="absolute top-1 right-1 p-1 bg-white/80 rounded-full text-gray-300 hover:text-red-500"><Icon name="trash" className="w-3 h-3" /></button>
                                        </div>
                                    ))}
                                </div>
                                {wardrobe.length === 0 && <div className="text-center py-12 text-gray-300 text-xs">Ë°£Ê´•Á©∫Á©∫Â¶Ç‰πü</div>}
                            </div>
                        )}

                        {activeTab === 'add' && (
                            <div className="p-6 animate-fade-in bg-white min-h-full">
                                <h2 className="text-xl font-bold mb-4">Êñ∞Â¢ûÂñÆÂìÅÂ∫´</h2>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar mb-4 pb-1">
                                    {SLOTS.filter(s => s.id !== 'coat').map(s => (
                                        <button key={s.id} onClick={() => handleSlotTabChange(s.id)} className={`px-4 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap border transition-colors ${whSlot === s.id ? 'bg-black text-white border-black' : 'bg-white text-gray-500 border-gray-200'}`}>{s.label}</button>
                                    ))}
                                </div>

                                {whSlot === 'inner' && (
                                    <div className="flex flex-col gap-2 mb-4">
                                        <div className="flex gap-2">
                                            <button onClick={() => setWhInnerSleeve('s')} className={`flex-1 py-1.5 text-xs font-bold rounded-md border transition-colors ${whInnerSleeve === 's' ? 'bg-gray-800 text-white' : 'bg-gray-50 text-gray-400'}`}>ÊúâË¢ñ (Standard)</button>
                                            <button onClick={() => setWhInnerSleeve('n')} className={`flex-1 py-1.5 text-xs font-bold rounded-md border transition-colors ${whInnerSleeve === 'n' ? 'bg-gray-800 text-white' : 'bg-gray-50 text-gray-400'}`}>ÁÑ°Ë¢ñ (Layering)</button>
                                        </div>
                                        <p className="text-[11px] text-[#4b5563] leading-relaxed">
                                            <span className="font-bold block mb-1">ÂøÖÈ†àÂêåÊôÇÊ∫ñÂÇôÊúâË¢ñËàáÁÑ°Ë¢ñÂñÆÂìÅ</span>
                                            ÁÑ°Ë¢ñÁî®ÊñºÂ§ñÂ•óÂ±§Ê¨°ÔºåÊúâË¢ñÁî®ÊñºÂñÆÁ©øÂ±ïÁèæÔºå‰ª•Á¢∫‰øùÊô∫ÊÖßÊê≠ÈÖçËÉΩÂëàÁèæÊúÄ‰Ω≥ÊïàÊûú„ÄÇ
                                        </p>
                                    </div>
                                )}

                                <div className="flex gap-2 overflow-x-auto no-scrollbar mb-4 pb-1">
                                    {getCurrentCategories().map(catKey => (
                                        <button 
                                            key={catKey} 
                                            onClick={() => whSlot === 'inner' ? handleInnerCatChange(catKey) : setWhCatCode(catKey)} 
                                            className={`cat-pill ${whCatCode.startsWith(catKey) || whCatCode === catKey ? 'active' : 'inactive'}`}
                                        >
                                            {CATEGORY_MAP[catKey] || CATEGORY_MAP[catKey+'s'] || catKey}
                                        </button>
                                    ))}
                                </div>

                                <div className="flex gap-3 overflow-x-auto no-scrollbar mb-6 py-1">
                                    {Object.entries(COLOR_MAP).map(([code, def]) => (
                                        <div key={code} className="flex flex-col items-center gap-1 cursor-pointer flex-shrink-0" onClick={() => setWhColorCode(code)}>
                                            <div className={`w-6 h-6 rounded-full transition-all shadow-sm ${whColorCode === code ? 'ring-2 ring-offset-2 ring-black scale-110' : 'hover:scale-105'}`} style={{ background: def.hex, border: def.border ? '1px solid #e5e7eb' : 'none' }}></div>
                                        </div>
                                    ))}
                                </div>

                                <div className="grid grid-cols-2 gap-3 pb-20">
                                    {getVirtualStock().map((item, idx) => (
                                        <div key={idx} onClick={() => handleAddItem(item)} className="warehouse-item relative group bg-white shadow-sm hover:shadow-md overflow-hidden">
                                            <img 
                                                src={`./${item.src}`} 
                                                alt="item" 
                                                style={whSlot === 'shoes' 
                                                    ? { width: '100%', height: '100%', objectFit: 'contain', transform: 'scale(3.5)', transformOrigin: 'bottom center', padding: 0 } 
                                                    : {}}
                                                onError={(e) => { e.target.parentElement.style.display = 'none'; }} /* Hide missing files */
                                            />
                                            <div className="absolute inset-0 flex items-center justify-center bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <span className="bg-black text-white text-[10px] px-2 py-1 rounded-full font-bold">ÂÖ•Â∫´</span>
                                            </div>
                                        </div>
                                    ))}
                                    {getVirtualStock().length === 0 && <div className="col-span-2 text-center text-xs text-gray-400 py-8">Êö´ÁÑ°Ê≠§Ë¶èÊ†ºÂúñÁâá</div>}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="bottom-nav">
                        <div onClick={() => setActiveTab('styling')} className={`nav-item ${activeTab === 'styling' ? 'active' : ''}`}><Icon name="hanger" className="w-6 h-6" /><span>Êê≠ÈÖç</span></div>
                        <div onClick={() => setActiveTab('closet')} className={`nav-item ${activeTab === 'closet' ? 'active' : ''}`}><Icon name="grid" className="w-6 h-6" /><span>Ë°£Ê´•</span></div>
                        <div onClick={() => setActiveTab('add')} className={`nav-item ${activeTab === 'add' ? 'active' : ''}`}><Icon name="plus" className="w-6 h-6" /><span>Êñ∞Â¢û</span></div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>